{% extends "base.html" %}
{% block title %}Live Chat | TableFlow{% endblock %}
{% block head %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const threadId = "{{ thread.id }}";
    const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + `/ws/chat/${threadId}/`);

    const form = document.querySelector("#chatForm");
    const input = document.querySelector("#chatInput");
    const box = document.querySelector("#chatBox");

    function addLine(sender, content, created_at) {
      const el = document.createElement("div");
      el.className = "chat-line";
      el.innerHTML = `
        <div class="small text-muted">${sender} • ${new Date(created_at).toLocaleString()}</div>
        <div class="p-2 rounded-3 bg-light border">${content}</div>
      `;
      box.appendChild(el);
      box.scrollTop = box.scrollHeight;
    }

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      addLine(msg.sender, msg.content, msg.created_at);
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;
      ws.send(JSON.stringify({message}));
      input.value = "";
    });

    // load existing messages via DOM
    {% for m in thread.messages.all %}
      addLine("{{ m.sender.username|escapejs }}", "{{ m.content|escapejs }}", "{{ m.created_at|date:'c' }}");
    {% endfor %}
  });
</script>
{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="fw-bold mb-0">Live Chat</h2>
      <div class="text-muted small">Ask anything—support replies in real time.</div>
    </div>
    {% if user.is_staff or user.is_support %}
      <a class="btn btn-outline-primary" href="{% url 'chat:support_inbox' %}">Support Inbox</a>
    {% endif %}
  </div>

  <div id="chatBox" class="chat-box border rounded-4 p-3 mb-3"></div>

  <form id="chatForm" class="d-flex gap-2">
    <input id="chatInput" class="form-control" placeholder="Type a message...">
    <button class="btn btn-primary">Send</button>
  </form>
{% endblock %}
